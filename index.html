<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdownie</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<link rel="stylesheet" href="assets/css/markdownie.css">
</head>
<body class="dark">
  <div class="header">
    <div class="header-left">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <span style="font-weight: 600;">Markdownie</span>
    </div>
    <div class="header-right">
      <button class="btn" id="openFolderBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        Open Folder
      </button>
      <button class="icon-btn" id="themeBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <div class="sidebar-header">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
        FILES
      </div>
      <div class="file-list" id="fileList">
        <div class="empty-state">
          No folder opened. Click "Open Folder" to begin.
        </div>
      </div>
    </div>

    <div class="content-area">
      <div class="preview" id="preview">
        <div class="placeholder">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p style="font-size: 16px;">Select a markdown file to preview</p>
        </div>
      </div>

      <div class="toc-panel" id="tocPanel" style="display: none;">
        <div class="toc-title">Table of Contents</div>
        <ul class="toc-list" id="tocList"></ul>
      </div>
    </div>
  </div>

  <script>
    let directoryHandle = null;
    let fileTree = {};

    // Configure marked for syntax highlighting
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    // Theme toggle
    const themeBtn = document.getElementById('themeBtn');
    const body = document.body;

    themeBtn.addEventListener('click', () => {
      body.classList.toggle('dark');
      body.classList.toggle('light');
      
      // Update highlight.js theme
      const hlTheme = document.querySelector('link[href*="highlight.js"]');
      if (body.classList.contains('light')) {
        hlTheme.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
      } else {
        hlTheme.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';
      }
    });

    // Open folder
    const openFolderBtn = document.getElementById('openFolderBtn');
    openFolderBtn.addEventListener('click', async () => {
      try {
        directoryHandle = await window.showDirectoryPicker();
        await loadFileTree(directoryHandle);
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Error opening folder:', err);
        }
      }
    });

    async function loadFileTree(handle, path = '') {
      const items = [];

      for await (const entry of handle.values()) {
        const itemPath = path ? `${path}/${entry.name}` : entry.name;
        
        if (entry.kind === 'directory') {
          const children = await loadFileTree(entry, itemPath);
          items.push({
            name: entry.name,
            type: 'folder',
            path: itemPath,
            children: children,
            handle: entry
          });
        } else if (entry.name.endsWith('.md')) {
          items.push({
            name: entry.name,
            type: 'file',
            path: itemPath,
            handle: entry
          });
        }
      }

      items.sort((a, b) => {
        if (a.type !== b.type) {
          return a.type === 'folder' ? -1 : 1;
        }
        return a.name.localeCompare(b.name);
      });

      if (path === '') {
        fileTree = items;
        renderFileTree();
      }

      return items;
    }

    function renderFileTree() {
      const fileList = document.getElementById('fileList');
      
      if (fileTree.length === 0) {
        fileList.innerHTML = '<div class="empty-state">No markdown files found in this folder.</div>';
        return;
      }

      fileList.innerHTML = '';
      renderTreeItems(fileTree, fileList);
    }

    function renderTreeItems(items, container, level = 0) {
      items.forEach(item => {
        if (item.type === 'folder') {
          const folderDiv = document.createElement('div');
          
          const folderBtn = document.createElement('button');
          folderBtn.className = 'folder-item';
          folderBtn.style.paddingLeft = `${12 + level * 16}px`;
          folderBtn.innerHTML = `
            <svg class="chevron expanded" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>${item.name}</span>
          `;

          const childrenDiv = document.createElement('div');
          childrenDiv.className = 'folder-children';

          folderBtn.addEventListener('click', () => {
            const chevron = folderBtn.querySelector('.chevron');
            chevron.classList.toggle('expanded');
            childrenDiv.classList.toggle('collapsed');
          });

          folderDiv.appendChild(folderBtn);
          folderDiv.appendChild(childrenDiv);
          container.appendChild(folderDiv);

          if (item.children.length > 0) {
            renderTreeItems(item.children, childrenDiv, level + 1);
          }
        } else {
          const fileBtn = document.createElement('button');
          fileBtn.className = 'file-item';
          fileBtn.style.paddingLeft = `${28 + level * 16}px`;
          fileBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <span>${item.name}</span>
          `;
          fileBtn.addEventListener('click', () => selectFile(item, fileBtn));
          container.appendChild(fileBtn);
        }
      });
    }

    async function selectFile(file, btn) {
      // Update active state
      document.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('active');
      });
      if (btn) btn.classList.add('active');

      try {
        const fileHandle = await file.handle.getFile();
        const text = await fileHandle.text();
        const html = marked.parse(text);

        const preview = document.getElementById('preview');
        preview.innerHTML = `<div class="preview-content"><div class="markdown-body">${html}</div></div>`;

        // Generate TOC
        generateTOC();

        // Show TOC panel
        document.getElementById('tocPanel').style.display = 'block';

        // Setup scroll spy
        setupScrollSpy();
      } catch (err) {
        console.error('Error reading file:', err);
        const preview = document.getElementById('preview');
        preview.innerHTML = '<div class="preview-content"><p>Error reading file</p></div>';
      }
    }

    function generateTOC() {
      const content = document.querySelector('.markdown-body');
      if (!content) return;

      const headings = content.querySelectorAll('h1, h2, h3, h4');
      const tocList = document.getElementById('tocList');
      tocList.innerHTML = '';

      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;

        const li = document.createElement('li');
        li.className = 'toc-item';

        const link = document.createElement('a');
        link.href = `#${id}`;
        link.className = `toc-link toc-${heading.tagName.toLowerCase()}`;
        link.textContent = heading.textContent;
        
        link.addEventListener('click', (e) => {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        li.appendChild(link);
        tocList.appendChild(li);
      });
    }

    function setupScrollSpy() {
      const preview = document.getElementById('preview');
      const tocLinks = document.querySelectorAll('.toc-link');
      
      preview.addEventListener('scroll', () => {
        const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4');
        
        let current = '';
        headings.forEach(heading => {
          const rect = heading.getBoundingClientRect();
          if (rect.top < 100) {
            current = heading.id;
          }
        });

        tocLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${current}`) {
            link.classList.add('active');
          }
        });
      });
    }
  </script>
</body>
</html>